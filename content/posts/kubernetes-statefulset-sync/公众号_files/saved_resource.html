<!DOCTYPE html>
<!-- saved from url=(0011)about:blank -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css">body{font-family:sans-serif;}</style><link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/mpres/zh_CN/htmledition/comm_htmledition/style/widget/ueditor_new/themes/iframe53af3e.css"><style id="checktext">mpchecktext,mptmpchecktext{display:none;}</style><style id="table">.selectTdClass{background-color:#edf5fa !important}table.noBorderTable td,table.noBorderTable th,table.noBorderTable caption{border:1px dashed #ddd !important}table{margin-bottom:10px;border-collapse:collapse;display:table;}td,th{padding: 5px 10px;border: 1px solid #DDD;}caption{border:1px dashed #DDD;border-bottom:0;padding:3px;text-align:center;}th{border-top:2px solid #BBB;background:#F7F7F7;}.ue-table-interlace-color-single{ background-color: #fcfcfc; } .ue-table-interlace-color-double{ background-color: #f7faff; }td p{margin:0;padding:0;}</style><style id="list">ol,ul{margin:0;padding:0;-webkit-box-sizing:border-box;box-sizing:border-box;width:99.9%}li{clear:both;}.list-paddingleft-1{padding-left:1.2em}
.list-paddingleft-2{padding-left:2.2em}
.list-paddingleft-3{padding-left:3.2em}</style></head><body class="view" lang="en" contenteditable="true" spellcheck="false" style="overflow-y: hidden; cursor: text; height: 5350px;"><section data-width="100%" data-opacity="1" data-rotate="0" style="width: 100%;margin-right: auto;margin-left: auto;opacity: 1;transform: rotateZ(0deg);"><section style="display: flex;justify-content: center;align-items: center;"><section><section data-width="100%" data-opacity="1" data-rotate="0" style="width: 100%;margin-right: auto;margin-left: auto;opacity: 1;transform: rotateZ(0deg);"><section style="display: flex;justify-content: center;align-items: center;"><section data-width="100%" data-opacity="1" data-rotate="0" style="width: 100%;margin-right: auto;margin-left: auto;opacity: 1;transform: rotateZ(0deg);"><section style="display: flex;justify-content: center;align-items: center;"><section><img data-ratio="1" src="https://mmbiz.qpic.cn/mmbiz_gif/FQzrnYr2ZmHynbQic9ic9Pic2C3TS7JySC5ibWOib5JPibkZEX0BIf1icaOj4llqfszDI3qMffib0lkNOxHibMoMecHIkzg/640?wx_fmt=gif" data-type="gif" data-w="400" style="width: 30px;display: inline-block;vertical-align:top;"></section><section style="display:inline-block;vertical-align: middle;margin-left:5px;"><p style="min-width:1px;font-size: 12px;">来这里找志同道合的小伙伴！<mpchecktext contenteditable="false" id="1616471964703_0.8474182169837863"></mpchecktext></p></section></section></section><section><br></section></section></section></section></section></section><h3 cid="n2" mdtype="heading" style=" box-sizing: border-box;break-after: avoid-page;break-inside: avoid;orphans: 4;font-size: 1.5em;margin-top: 1rem;margin-bottom: 1rem; font-weight: bold;line-height: 1.43;cursor: text;white-space: pre-wrap; "><span md-inline="plain" style="box-sizing: border-box;">背景<mpchecktext contenteditable="false" id="1616471964704_0.9097538165562855"></mpchecktext></span></h3><p cid="n3" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">线上kubernetes集群从创建StatefulSet到创建pod需要时间很长，分钟级别，但是调度却很快。<mpchecktext contenteditable="false" id="1616471964774_0.07737831340525658"></mpchecktext>偶尔还会出现导致上层任务超过的情况。<mpchecktext contenteditable="false" id="1616471964763_0.1843560959024344"></mpchecktext>为了方便书写，下文统一用sts代指StatefulSet。<mpchecktext contenteditable="false" id="1616471964775_0.591773248050596"></mpchecktext>​</span></p><h3 cid="n4" mdtype="heading" style=" box-sizing: border-box;break-after: avoid-page;break-inside: avoid;orphans: 4;font-size: 1.5em;margin-top: 1rem;margin-bottom: 1rem; font-weight: bold;line-height: 1.43;cursor: text;white-space: pre-wrap; "><span md-inline="plain" style="box-sizing: border-box;">排查过程<mpchecktext contenteditable="false" id="1616471964776_0.3210781619473897"></mpchecktext></span></h3><p cid="n5" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">分析可能的原因：<mpchecktext contenteditable="false" id="1616471964708_0.9554214013412745"></mpchecktext></span></p><ul class=" list-paddingleft-2" cid="n6" mdtype="list" data-mark="-" style=" margin-top: 0.8em;margin-bottom: 0.8em;padding-left: 30px;  "><li style=" box-sizing: border-box;  "><p cid="n8" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-bottom: 0.5rem;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">watch到sts的变化有延迟<mpchecktext contenteditable="false" id="1616471964709_0.07661721130886723"></mpchecktext></span></p></li><li style=" box-sizing: border-box;  "><p cid="n10" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-bottom: 0.5rem;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">sts从入队列到出队列耗时长<mpchecktext contenteditable="false" id="1616471964710_0.46489364655353493"></mpchecktext></span></p></li><li style=" box-sizing: border-box;  "><p cid="n12" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-bottom: 0.5rem;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">处理sts耗时长<mpchecktext contenteditable="false" id="1616471964711_0.7048800964500779"></mpchecktext></span></p></li></ul><p cid="n13" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">kube-controller-manager<span data-splitid="1616471964712_0.1825752173556252" class="character selected js_checktext" data-text="%E4%B8%AD">中</span>sts相关源码中有一些日志，需要把loglevel设置为4，即调试级别才会打印，里面就包括处理单个sts的耗时。<mpchecktext contenteditable="false" id="1616471964712_0.1825752173556252"></mpchecktext>首先把kube-controller-manager日志级别调到4，日志如下图, 最后显示的时间是从队列中拿到sts到处理完sts的整个过程的耗时，可以看到耗时并不长，在毫秒级别，那就可以排除掉处理单个sts耗时长的可能性了。<mpchecktext contenteditable="false" id="1616471964713_0.00749718820004186"></mpchecktext></span></p><p style="text-align: center"><img data-s="300,640" class="rich_pages js_insertlocalimg" src="https://mmbiz.qlogo.cn/mmbiz_png/FQzrnYr2ZmHynbQic9ic9Pic2C3TS7JySC5CutuWH2ZXPCTvxx1RyZCibicUmlJza1iar1yfkPrVHFVodLmq8stqAKLA/0?wx_fmt=png" style="width: 100%; height: auto;" data-ratio="0.23203125" data-w="1280" data-backw="578" data-backh="134" data-type="png"></p><p cid="n15" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">还剩下两种可能，不过细想的话，第一种可能也不大，因为watch是通用的，没道理同一个集群kube-controller-manager里的watch就慢，kube-scheuler的watch就快。<mpchecktext contenteditable="false" id="1616471964714_0.13841518473918946"></mpchecktext>那就很有可能是从watch到变化后把sts入队列到从队列中拿到sts这个阶段耗时太长了。<mpchecktext contenteditable="false" id="1616471964715_0.8166499079882084"></mpchecktext>源码中并没有这一部分的耗时统计，但是从源码中可以看到整个处理过程是同步到的，即watch的所有sts按顺序入队列，消费者在顺序的从队列中拿到，每消费完一个，再去拿另一个，串行执行，那问题就来了，虽然单个sts执行耗时在毫秒级，但是整个集群的sts数量在2000+，按平均每个sts耗时40ms计算，粗略估算一下处理完一轮的话也需要40ms*2000=80s的时间，到这里已经离真相不远了，但还有一个问题，那就是kube-controller-manager在初始化的时候是会把所有的sts加载一遍放入队列中的，处理完一遍哪怕耗时2分钟，但是处理完一遍之后只watch变化的sts，数量就会少很多了，所以处理完初始化时加载的所有sts后，按道理再有sts变化应该是可以及时处理的，因为此时队列中基本没有sts了。<mpchecktext contenteditable="false" id="1616471964745_0.47573387294519365"></mpchecktext>带着问题再去看源码，发现了一个神奇的地方，如下<mpchecktext contenteditable="false" id="1616471964746_0.570959015974783"></mpchecktext></span></p><pre class="code-snippet code-snippet_nowrap code-snippet__js" data-lang="go"><code><span class="code-snippet_outer">setInformer.Informer().AddEventHandlerWithResyncPeriod(</span></code><code><span class="code-snippet_outer">   cache.ResourceEventHandlerFuncs{</span></code><code><span class="code-snippet_outer">      AddFunc: ssc.enqueueStatefulSet,</span></code><code><span class="code-snippet_outer">      UpdateFunc: <span class="code-snippet__function"><span class="code-snippet__keyword">func</span><span class="code-snippet__params">(old, cur <span class="code-snippet__keyword">interface</span>{})</span></span> {</span></code><code><span class="code-snippet_outer">         oldPS := old.(*apps.StatefulSet)</span></code><code><span class="code-snippet_outer">         curPS := cur.(*apps.StatefulSet)</span></code><code><span class="code-snippet_outer">         <span class="code-snippet__keyword">if</span> oldPS.Status.Replicas != curPS.Status.Replicas {</span></code><code><span class="code-snippet_outer">            glog.V(<span class="code-snippet__number">4</span>).Infof(<span class="code-snippet__string">"Observed updated replica count for StatefulSet: %v, %d-&gt;%d"</span>, curPS.Name, oldPS.Status.Replicas, curPS.Status.Replicas)</span></code><code><span class="code-snippet_outer">         }</span></code><code><span class="code-snippet_outer">         ssc.enqueueStatefulSet(cur)</span></code><code><span class="code-snippet_outer">      },</span></code><code><span class="code-snippet_outer">      DeleteFunc: ssc.enqueueStatefulSet,</span></code><code><span class="code-snippet_outer">   },</span></code><code><span class="code-snippet_outer">   statefulSetResyncPeriod, <span class="code-snippet__comment">// 30s</span></span></code><code><span class="code-snippet_outer">)<mpchecktext contenteditable="false" id="1616471964757_0.7549613119944982"></mpchecktext></span></code></pre><p cid="n17" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">这就对了，上面这段代码意思是只要watch到sts的变化，就会把对应的sts放入队列，</span><span md-inline="strong" style="box-sizing: border-box;"><strong style="box-sizing: border-box;"><span md-inline="plain" style="box-sizing: border-box;">且每隔30s</span></strong><span md-inline="plain" style="box-sizing: border-box;">会把全部sts</span><span md-inline="plain" style="box-sizing: border-box;">重新入一遍队列，再加上刚才的估算，80s才能处理完所有sts，在未处理完之前（处理了30s时）就又会把所有的sts重新加入到队列中（并不是简单粗暴的把所有sts入队列，中间还会做一些处理，过滤掉一些不需要重复入队列的sts），这就会导致sts的待处理队列中始终有2000+个元素，新watch到的变化会加到队尾，从而导致sts创建后过了很久Pod才创建，因为sts controller一直在消费之前未处理完的其他sts了。<mpchecktext contenteditable="false" id="1616471964759_0.952992823415789"></mpchecktext></span></span></p><p cid="n18" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">下面写了一个Demo来演示这个问题，代码很简单，如下<mpchecktext contenteditable="false" id="1616471964720_0.810980618699517"></mpchecktext></span></p><pre spellcheck="false" lang="go" cid="n19" mdtype="fences" style=" box-sizing: border-box;overflow: visible;font-family: var(--monospace);font-size: 0.9em;break-inside: avoid;text-align: left;white-space: normal;background-image: inherit;background-size: inherit;background-attachment: inherit;background-origin: inherit;background-clip: inherit;background-color: rgb(248, 248, 248);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);border-radius: 3px;padding-top: 8px;padding-right: 4px;padding-bottom: 6px;margin-bottom: 15px;margin-top: 15px;width: inherit;  ">&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> <span style="box-sizing: border-box;color: rgb(119, 0, 136);">package</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">main</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">import</span> (</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"fmt"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"k8s.io/api/apps/v1"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"k8s.io/client-go/informers"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"k8s.io/client-go/kubernetes"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"k8s.io/client-go/rest"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"k8s.io/client-go/tools/cache"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"k8s.io/client-go/util/workqueue"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"log"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"math/rand"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"time"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"unsafe"</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">var</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">workqueue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">RateLimitingInterface</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">main</span>() {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">defer</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">ShutDown</span>()</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">clientset</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">_</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">kubernetes</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">NewForConfig</span>(<span style="box-sizing: border-box;color: rgb(152, 26, 26);">&amp;</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">rest</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Config</span>{</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">Host</span>: <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"http://10.89.107.26:8080"</span>,</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; })</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">factor</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">rand</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Float64</span>() <span style="box-sizing: border-box;color: rgb(152, 26, 26);">+</span> <span style="box-sizing: border-box;color: rgb(17, 102, 68);">1</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">syncPeriod</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">time</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Duration</span>(<span style="box-sizing: border-box;color: rgb(119, 0, 136);">float64</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">time</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Duration</span>(<span style="box-sizing: border-box;color: rgb(17, 102, 68);">12</span><span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">time</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Hour</span>)<span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Nanoseconds</span>()) <span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">factor</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">informerFactory</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">informers</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">NewSharedInformerFactory</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">clientset</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">syncPeriod</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">stopChan</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(34, 17, 153);">make</span>(<span style="box-sizing: border-box;color: rgb(119, 0, 136);">chan</span> <span style="box-sizing: border-box;color: rgb(119, 0, 136);">struct</span>{})</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">informerFactory</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Start</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">stopChan</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">informerFactory</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">WaitForCacheSync</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">stopChan</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">stsInformer</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">informerFactory</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Apps</span>()<span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">V1</span>()<span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">StatefulSets</span>()<span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Informer</span>()</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 85, 0);">// 和sts controller一直，30s同步一遍所有sts</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">stsInformer</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">AddEventHandlerWithResyncPeriod</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">cache</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">ResourceEventHandlerFuncs</span>{</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">AddFunc</span>: &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">onAdd</span>,</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">UpdateFunc</span>: <span style="box-sizing: border-box;color: rgb(0, 0, 0);">onUpdate</span>,</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">DeleteFunc</span>: <span style="box-sizing: border-box;color: rgb(0, 0, 0);">onDelete</span>,</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; }, <span style="box-sizing: border-box;color: rgb(17, 102, 68);">30</span><span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">time</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Second</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">go</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">consume</span>()</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">stsInformer</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Run</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">stopChan</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">}</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">init</span>() {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span> <span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">workqueue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">NewNamedRateLimitingQueue</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">workqueue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">DefaultControllerRateLimiter</span>(), <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"statefulset"</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">}</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">consume</span>() {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">for</span> {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span>() {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">key</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">quit</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Get</span>()</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">if</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">quit</span> {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">fmt</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Println</span>(<span style="box-sizing: border-box;color: rgb(170, 17, 17);">"done"</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(119, 0, 136);">return</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; }</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">defer</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Done</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">key</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">key</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span>(<span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">v1</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">StatefulSet</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(170, 85, 0);">// 模拟处理单个sts耗时40ms</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">time</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Sleep</span>(<span style="box-sizing: border-box;color: rgb(17, 102, 68);">40</span> <span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">time</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Millisecond</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">log</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Printf</span>(<span style="box-sizing: border-box;color: rgb(170, 17, 17);">"cosumed %s, queue count: %d"</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Name</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Len</span>())</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp;  }()</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; }</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">}</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">onAdd</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">obj</span> <span style="box-sizing: border-box;color: rgb(119, 0, 136);">interface</span>{}) {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">obj</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span>(<span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">v1</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">StatefulSet</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">if</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Name</span> <span style="box-sizing: border-box;color: rgb(152, 26, 26);">==</span> <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"test-delay-sf-60f09"</span> {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">log</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Printf</span>(<span style="box-sizing: border-box;color: rgb(170, 17, 17);">"add address: %d"</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">unsafe</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Pointer</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span>))</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; }</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Add</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">}</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">onUpdate</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">old</span>, <span style="box-sizing: border-box;color: rgb(34, 17, 153);">new</span> <span style="box-sizing: border-box;color: rgb(119, 0, 136);">interface</span>{}) {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">old</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span>(<span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">v1</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">StatefulSet</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 85, 0);">// 测试用的sts，观察全量同步时的地址变化，用来确定是不通批次的同步，针对同一个sts来说是否地址相同</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(170, 85, 0);">// 因为queue中用到sts作为map的key，所以此处打印地址，验证一下</span></span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">if</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Name</span> <span style="box-sizing: border-box;color: rgb(152, 26, 26);">==</span> <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"test-delay-sf-60f09"</span> {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">log</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Printf</span>(<span style="box-sizing: border-box;color: rgb(170, 17, 17);">"update address: %d"</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">unsafe</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Pointer</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span>))</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; }</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Add</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">}</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> </span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"><span style="box-sizing: border-box;color: rgb(119, 0, 136);">func</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">onDelete</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">obj</span> <span style="box-sizing: border-box;color: rgb(119, 0, 136);">interface</span>{}) {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span> :<span style="box-sizing: border-box;color: rgb(152, 26, 26);">=</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">obj</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span>(<span style="box-sizing: border-box;color: rgb(152, 26, 26);">*</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">v1</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">StatefulSet</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(119, 0, 136);">if</span> <span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Name</span> <span style="box-sizing: border-box;color: rgb(152, 26, 26);">==</span> <span style="box-sizing: border-box;color: rgb(170, 17, 17);">"test-delay-sf-60f09"</span> {</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span style="box-sizing: border-box;color: rgb(0, 0, 0);">log</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Printf</span>(<span style="box-sizing: border-box;color: rgb(170, 17, 17);">"update address: %d"</span>, <span style="box-sizing: border-box;color: rgb(0, 0, 0);">unsafe</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Pointer</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span>))</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; }</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;"> &nbsp; <span style="box-sizing: border-box;color: rgb(0, 0, 0);">queue</span><span style="box-sizing: border-box;color: rgb(17, 102, 68);">.</span><span style="box-sizing: border-box;color: rgb(0, 0, 0);">Add</span>(<span style="box-sizing: border-box;color: rgb(0, 0, 0);">sts</span>)</span><br>&nbsp;<span role="presentation" style="box-sizing: border-box;padding-right: 0.1px;">}<mpchecktext contenteditable="false" id="1616471964721_0.6604772696443217"></mpchecktext></span></pre><p cid="n20" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">最终的输出结果<mpchecktext contenteditable="false" id="1616471964722_0.21105603154605812"></mpchecktext></span></p><p style="text-align: center"><img data-s="300,640" class="rich_pages js_insertlocalimg" src="https://mmbiz.qlogo.cn/mmbiz_png/FQzrnYr2ZmHynbQic9ic9Pic2C3TS7JySC5YQC19SiaRHbKhnVN0XjFFB0ibLTFrn0KJIPVPBia3eDFStEeP8MwazSBg/0?wx_fmt=png" style="width: 100%; height: auto;" data-ratio="0.46875" data-w="1280" data-type="png" data-backw="578" data-backh="271"></p><p style="text-align: center"><img data-s="300,640" class="rich_pages js_insertlocalimg" src="https://mmbiz.qlogo.cn/mmbiz_png/FQzrnYr2ZmHynbQic9ic9Pic2C3TS7JySC5mvJJnyvHTwM2QO2bdsvAEliaIWdiatgEnS22UgkVr8sibFIPyhDXw89Pg/0?wx_fmt=png" style="width: 100%; height: auto;" data-ratio="0.4484375" data-w="1280" data-type="png" data-backw="578" data-backh="259"><span style="font-family: monospace; orphans: 4; white-space: pre-wrap; text-align: justify;">​</span></p><p cid="n23" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">可以看到queue的长度从一开始的2000+一直降到1525，此时同步了一遍全量的sts，即2000+，queue中元素数量又升了上去。<mpchecktext contenteditable="false" id="1616471964742_0.9956241404596611"></mpchecktext>同时在未修改sts的情况，指定sts同步后的地址和同步前的地址相同824689074368。<mpchecktext contenteditable="false" id="1616471964724_0.5895300413381539"></mpchecktext>验证了之前的猜想，问题就出在了这里。<mpchecktext contenteditable="false" id="1616471964725_0.3556759389126163"></mpchecktext></span></p><h3 cid="n24" mdtype="heading" style=" box-sizing: border-box;break-after: avoid-page;break-inside: avoid;orphans: 4;font-size: 1.5em;margin-top: 1rem;margin-bottom: 1rem; font-weight: bold;line-height: 1.43;cursor: text;white-space: pre-wrap; "><span md-inline="plain" style="box-sizing: border-box;">解决方案<mpchecktext contenteditable="false" id="1616471964726_0.027248357945137913"></mpchecktext></span></h3><p cid="n25" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">想到两种优化方案<mpchecktext contenteditable="false" id="1616471964727_0.595949145681707"></mpchecktext></span></p><ol class=" list-paddingleft-2" start="" cid="n26" mdtype="list" style=" margin-top: 0.8em;margin-bottom: 0.8em;padding-left: 30px;  "><li style=" box-sizing: border-box;  "><p cid="n28" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-bottom: 0.5rem;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">去掉定期（30s）全量同步的机制，目前看其他controller，如ReplicationController，ServiceController，EndpointsController等都没有设置定期全量同步<mpchecktext contenteditable="false" id="1616471964728_0.5188336496860815"></mpchecktext></span></p></li><li style=" box-sizing: border-box;  "><p cid="n30" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-bottom: 0.5rem;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">保留定期同步，添加已处理的sts的缓存，每次从queue中拿到一个新的sts时，比较已处理缓存中是否存在相同的sts(resourceversion相同)，存在则忽略此sts，否则进行处理<mpchecktext contenteditable="false" id="1616471964744_0.10298217477495863"></mpchecktext></span></p></li></ol><h3 cid="n31" mdtype="heading" style=" box-sizing: border-box;break-after: avoid-page;break-inside: avoid;orphans: 4;font-size: 1.5em;margin-top: 1rem;margin-bottom: 1rem; font-weight: bold;line-height: 1.43;cursor: text;white-space: pre-wrap; "><span md-inline="plain" style="box-sizing: border-box;">社区<mpchecktext contenteditable="false" id="1616471964730_0.988023059843179"></mpchecktext></span></h3><p cid="n32" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="plain" style="box-sizing: border-box;">上述问题已反馈社区，见</span><span md-inline="linebreak" style="box-sizing: border-box;font-family: var(--monospace);opacity: 0.6;color: inherit;"> &nbsp;<mpchecktext contenteditable="false" id="1616471964734_0.12581211193039343"></mpchecktext></span></p><p cid="n32" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="url" spellcheck="false" style="box-sizing: border-box;word-break: break-all;">https://github.com/kubernetes/kubernetes/issues/75495<mpchecktext contenteditable="false" id="1616471964735_0.6170761771663562"></mpchecktext></span></p><p cid="n33" mdtype="paragraph" style=" box-sizing: border-box;line-height: inherit;orphans: 4;margin-top: 0.8em;margin-bottom: 0.8em;white-space: pre-wrap;  "><span md-inline="url" spellcheck="false" style="box-sizing: border-box;word-break: break-all;">https://github.com/kubernetes/kubernetes/pull/75622<mpchecktext contenteditable="false" id="1616471964732_0.7989545272096192"></mpchecktext></span></p><section data-width="100%" data-opacity="1" data-rotate="0" style="width: 100%;margin-right: auto;margin-left: auto;opacity: 1;transform: rotateZ(0deg);"><section style="display: flex;justify-content: flex-end;align-items: center;"><section style="display: inline-block;text-align: right;"><section style="letter-spacing: 2px;margin-bottom: -15px;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-ms-transform: rotate(0deg);-o-transform: rotate(0deg);"><p style="font-size: 15px;color: rgb(63, 63, 63);min-width:1px;">我就知道你“在看”<mpchecktext contenteditable="false" id="1616471964733_0.8855170351227075"></mpchecktext></p></section></section><section style="width:22px;"><section style="width:22px;margin-top: 15px;"><img data-ratio="1.0377358490566038" src="https://mmbiz.qpic.cn/mmbiz_gif/FQzrnYr2ZmHynbQic9ic9Pic2C3TS7JySC5szoCSL1ZdhGyvJfoxAsLqXE3QboG4t4AibENdRY5bBgiaib0UP28y9X1w/640?wx_fmt=gif" data-type="gif" data-w="53" style="width: 100%;display:block;vertical-align:top;"></section></section></section></section><p><br></p></body></html>